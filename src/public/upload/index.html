<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/common.css">
	<title>Splitter | Upload</title>
</head>
<body>
	<input type="file" id="file" />
	<br />
	<button id="upload">Upload</button>
	<br />
	<p id="status"></p>

	<script>
		const token = new URL(window.location).searchParams.get("token");

		const fileInput = document.getElementById("file");
		const uploadButton = document.getElementById("upload");
		const statusText = document.getElementById("status");

		async function sendPart(partNumber, totalParts, filename, blob) {
			const formData = new FormData();
			formData.append("file", blob, filename);
			formData.append("partNumber", partNumber);
			formData.append("totalParts", totalParts);
			try {
				const response = await fetch("/file", {
					method: "PATCH",
					headers: {
						Authorization: token,
					},
					body: formData,
				});
				switch (response.status) {
					case 202:
					case 204:
						// Uploaded successfully
						return true;
					case 401:
						statusText.innerText = "‚ùå Token has expired or is invalid.";
						return false;
					default:
						console.error({response});
						statusText.innerText = "‚ùå Unexpected response from the server. Check the console for more info.";
				}
			} catch (error) {
				console.error({error});
				statusText.innerText = "‚ùå Failed to send part. Check the console for more info.";
				return false;
			}
		}

		uploadButton.addEventListener("click", async () => {
			/**
			 * @type {File}
			 */
			const file = fileInput.files[0];
			const buffer = await file.arrayBuffer();
			const chunkSize = 1024 * 1024 * 8; // 8 MB
			const totalParts = Math.ceil(buffer.byteLength / chunkSize);

			if (totalParts === 1) {
				statusText.innerText = "‚ùå Hey, this file is already 8 MB! Just go upload it straight to Discord!";
				return;
			}

			let beg = 0;
			let end = chunkSize;

			for (let partNumber = 1; partNumber <= totalParts; partNumber++) {
				statusText.innerText = `üì§ Uploading part ${partNumber} of ${totalParts}`;
				const slice = buffer.slice(beg, end);
				const blob = new Blob([slice], { type: "application/octet-stream" });

				const success = await sendPart(
					partNumber,
					totalParts,
					file.name,
					blob
				);
				if (!success) return;

				beg = end;
				end += chunkSize;
			}
			statusText.innerText = "‚úÖ Upload complete";
		});
	</script>
</body>
</html>