<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Splitter | Download</title>
</head>
<body>
	<p id="status">Loading...</p>

	<script>
		const fileID = window.location.pathname.split("/")[2];
		const statusText = document.getElementById("status");

		function getPartURLs(fileID) {
			statusText.innerText = "ðŸ“¥ Fetching part URLs...";
			try {
				return fetch(`/parts/${fileID}`, {
					headers: {
						"X-Requested-With": "XMLHttpRequest",
					}
				}).then(res => res.json());
			} catch (error) {
				statusText.innerText = "âŒ Failed to fetch part URLs. See the console for more details";
				console.log(error);
			}
		}

		// Concatenate the files and download it back as a single file.
		document.addEventListener("DOMContentLoaded", async () => {
			// Download the parts.
			const { filename, urls } = await getPartURLs(fileID);
			urls.sort();
			const blobPromises = [];
			for (const [i, url] of urls.entries()) {
				statusText.innerText = `ðŸ“¥ Downloading part ${i + 1} of ${urls.length}...`;
				const blobPromise = fetch(url, {
					headers: {
						"X-Requested-With": "XMLHttpRequest",
						"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36"
					}
				}).then(res => res.blob());
				blobPromises.push(blobPromise);
			}

			statusText.innerText = `ðŸ”ƒ Processing parts...`;
			const blobs = await Promise.all(blobPromises);

			// Merge the blobs and download it.
			statusText.innerText = "ðŸ”ƒ Merging parts...";
			const mergedBlob = new Blob(blobs, {
				type: "application/octet-stream",
			});

			statusText.innerText = "ðŸ”ƒ Preparing download...";
			const objectURL = URL.createObjectURL(mergedBlob);
			const link = document.createElement("a");
			link.href = objectURL;
			link.download = filename;
			statusText.innerText = "âœ… Enjoy!";
			link.click();
		});
	</script>
</body>
</html>